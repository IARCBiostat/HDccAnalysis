% Generated by roxygen2: do not edit by hand
% Please edit documentation in R/sim_cox_age_data_helpers.R
\name{.scale_to_avg_inc}
\alias{.scale_to_avg_inc}
\title{Scale baseline hazard to a target average incidence rate}
\usage{
.scale_to_avg_inc(tbl, entry_age, censor_age, avg_inc_rate, exp_eta)
}
\arguments{
\item{tbl}{data.frame with columns \code{age_lo}, \code{age_hi}, \code{rate}.
Defines the baseline hazard over attained age bands
\code{[age_lo, age_hi)}.}

\item{entry_age}{Numeric vector of entry ages.}

\item{censor_age}{Numeric vector of exit/censoring ages.}

\item{avg_inc_rate}{Optional positive scalar giving the desired average
incidence rate over the cohort's follow-up. If \code{NULL}, \code{tbl} is
returned unchanged.}

\item{exp_eta}{Numeric vector of length \code{length(entry_age)} giving the
subject-specific hazard multipliers \eqn{\exp(x\beta)} used when computing
expected events and expected time at risk.}
}
\value{
A data.frame identical to \code{tbl} but with \code{rate} scaled so
that the cohort's expected average incidence rate equals
\code{avg_inc_rate}.
}
\description{
Adjusts the rates in an attained-age baseline hazard table so that the
cohort's \strong{expected} average incidence rate equals a user-specified target.
The expectation is taken under a piecewise-constant proportional hazards
model with subject-specific multiplier \code{exp_eta}.
}
\details{
The function finds a single scaling factor \eqn{s} applied to all baseline
rates \eqn{\lambda_k} such that
\deqn{
  \frac{\mathbb{E}[N(s)]}{\mathbb{E}[T(s)]} = \texttt{avg\_inc\_rate},
}
where \eqn{\mathbb{E}[N(s)] = \sum_i \{1 - \exp(-H_i(s))\}} is the expected
number of events and \eqn{\mathbb{E}[T(s)]} is the expected time at risk,
both implied by the scaled hazards over each subject's follow-up window
\code{[entry_age, censor_age)} and the attained-age bands
\code{[age_lo_k, age_hi_k)}.

All baseline rates are multiplied by the same factor, so relative hazards
are unchanged; only the marginal event rate is altered.

The target average incidence rate is defined for the cohort under the model
implied by \code{tbl} and \code{exp_eta}. Scaling is performed by solving for
the multiplicative factor using \code{\link[stats]{uniroot}}.

If \code{avg_inc_rate} is non-\code{NULL} and not a positive finite number,
the function errors. If a bracketing interval for the root cannot be found,
the function errors.
}
\examples{
tbl <- data.frame(
  age_lo = c(50, 60),
  age_hi = c(60, 70),
  rate   = c(0.01, 0.02)
)

entry_age  <- c(52, 55, 61)
censor_age <- c(65, 63, 69)
exp_eta    <- rep(1, length(entry_age))

.scale_to_avg_inc(tbl, entry_age, censor_age, avg_inc_rate = 0.015, exp_eta)
}
\seealso{
\code{\link{sim_cox_age_data}}
}
